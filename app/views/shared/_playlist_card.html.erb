<%
  # Generate unique modal ID based on resource type and ID
  modal_id = "share_modal_#{resource.class.name.downcase}_#{resource.id}"
  show_scholar = local_assigns.fetch(:show_scholar, false)
  custom_icon = local_assigns.fetch(:custom_icon, "book-open")

  if resource.is_a?(Lesson)
    share_url = polymorphic_url(resource.series)
    resource_link = polymorphic_path(resource.series)
  elsif resource.is_a?(Lecture)
    share_url = lecture_url(resource.scholar, resource, kind: t("activerecord.attributes.lecture.kind.#{resource.kind}", default: resource.kind))
    resource_link = lecture_path(resource.scholar, resource, kind: t("activerecord.attributes.lecture.kind.#{resource.kind}", default: resource.kind))
  elsif resource.is_a?(Article)
    share_url = article_url(resource.scholar, resource)
    resource_link = article_path(resource.scholar, resource)
  else
    share_url = polymorphic_url(resource)
    resource_link = polymorphic_path(resource)
  end

  linkable = local_assigns[:linkable].present? ? local_assigns[:linkable] : false
%>
<div class="p-4 hover:bg-gray-50 transition">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div class="flex items-center gap-4 flex-1 min-w-0">
      <% if local_assigns[:with_icon].present? %>
        <div class="p-2 rounded border border-base-300 flex-shrink-0">
          <%= icon custom_icon, class: "size-5" %>
        </div>
      <% else %>
        <% if local_assigns[:index].present? %>
          <span class="text-gray-500 w-8 text-center text-base font-medium flex-shrink-0"><%= local_assigns[:index] + 1 %></span>
        <% end %>
      <% end %>
      <div class="flex-1 min-w-0">
        <% if show_scholar %>
          <% scholar = nil %>
          <% if resource.respond_to?(:scholar) && resource.scholar.present? %>
            <% scholar = resource.scholar %>
          <% elsif resource.respond_to?(:series) && resource.series&.scholar.present? %>
            <% scholar = resource.series.scholar %>
          <% end %>
        <% end %>
      
        <div class="flex items-center gap-2 flex-wrap">
          <% if linkable %>
            <%= link_to resource_link do %>
              <h3 class="font-medium text-lg hover:link"><%= resource.title %></h3>
            <% end %>
          <% else %>
            <h3 class="font-medium text-lg"><%= resource.title %></h3>
          <% end %>
          <% if local_assigns[:show_category].present? && resource.respond_to?(:category) && resource.category.present? %>
            <span class="badge badge-primary badge-sm"><%= resource.category %></span>
          <% end %>
        </div>
        <% if scholar.present? %>
          <div class="flex items-center gap-1">
            <%= icon "user", class: "size-4 text-gray-500" %>
            <span class="text-sm text-gray-600 truncate">
              <%= link_to scholar.name, scholar_path(scholar), class: "hover:link" %>
            </span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="flex items-center gap-2 flex-shrink-0 justify-end">
    <% if resource.respond_to?(:has_any_audio?) && resource.has_any_audio? %>
      <%= play_button(resource: resource, klass: "btn btn-secondary btn-sm") %>
      <%= link_to(direct_download_url(resource.best_audio), download: true, target: "_blank", class: "btn btn-secondary btn-sm w-fit") do %>
        <%= icon "arrow-down-tray", class: "size-3 sm:size-5" %>
      <% end %>
    <% elsif resource.respond_to?(:video?) && resource.video? %>
      <%= video_modal_button(resource:, klass: "btn btn-secondary btn-sm") %>
      <%= link_to(direct_download_url(resource.video), download: true, target: "_blank", class: "btn btn-secondary btn-sm w-fit") do %>
        <%= icon "arrow-down-tray", class: "size-3 sm:size-5" %>
      <% end %>
    <% elsif resource.respond_to?(:youtube_url?) && resource.youtube_url? %>
      <%= youtube_modal_button(resource:, klass: "btn btn-secondary btn-sm") %>
    <% end %>
    <button class="btn btn-secondary btn-sm"
            data-controller="share-trigger"
            data-share-trigger-modal-id-value="<%= modal_id %>"
            data-action="click->share-trigger#open">
      <%= icon "share", class: "size-4"%>
    </button>
  </div>
</div>
<%= render 'shared/share_modal',
    modal_id: modal_id,
    url: share_url,
    title: resource.title,
    text: resource.title %>
