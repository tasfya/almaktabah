<%
  # Generate unique modal ID based on resource type and ID
  modal_id = "share_modal_#{resource.class.name.downcase}_#{resource.id}"
  share_url = resource.is_a?(Lesson) ? polymorphic_url(resource.series) : polymorphic_url(resource)
  show_scholar = local_assigns.fetch(:show_scholar, false)

  # Control whether the title links to the resource show page
  link_to_resource = local_assigns.fetch(:link_to_resource, false)
%>
<div class="p-4 hover:bg-gray-50 transition">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div class="flex items-center gap-4 flex-1 min-w-0">
      <% if local_assigns[:with_icon].present? %>
        <div class="p-2 rounded border border-background-contrast flex-shrink-0">
          <%= icon "book-open", class: "size-5" %>
        </div>
      <% else %>
        <% if local_assigns[:index].present? %>
          <span class="text-gray-500 w-8 text-center text-base font-medium flex-shrink-0"><%= local_assigns[:index] + 1 %></span>
        <% end %>
      <% end %>
      <div class="flex-1 min-w-0">
        <h3 class="font-medium text-base mb-1 truncate">
          <% if link_to_resource %>
            <%= link_to resource.title, polymorphic_path(resource), class: "hover:underline" %>
          <% else %>
            <%= resource.title %>
          <% end %>
        </h3>
        <% if show_scholar %>
          <% scholar = nil %>
          <% if resource.respond_to?(:scholar) && resource.scholar.present? %>
            <% scholar = resource.scholar %>
          <% elsif resource.respond_to?(:series) && resource.series&.scholar.present? %>
            <% scholar = resource.series.scholar %>
          <% end %>
        <% end %>
        <% if scholar.present? %>
          <div class="flex items-center gap-1">
            <%= icon "user", class: "size-4 text-gray-500" %>
            <span class="text-base text-gray-600 truncate">
              <%= link_to scholar.name, scholar_path(scholar), class: "hover:link" %>
            </span>
          </div>
        <% end %>
        <% if resource.respond_to?(:youtube_url) && resource.youtube_url.present? %>
          <a href="<%= youtube_embed_url(resource.youtube_url) %>" target="_blank"
              class="text-sm text-gray-500 hover:underline flex items-center gap-2">
            <%= icon "youtube", library: "lucide", class: "size-4" %>
            <span>YouTube</span>
          </a>
        <% end %>
      </div>
    </div>
  </div>
  <div class="flex items-center gap-2 flex-shrink-0 justify-end">
    <% if resource.has_any_audio? %>
      <%= play_button(resource: resource, klass: "btn btn-secondary btn-sm") %>
      <%= link_to(rails_blob_url(resource.best_audio, disposition: "attachment"), download: true, target: "_blank", class: "btn btn-secondary btn-sm w-fit") do %>
        <%= icon "arrow-down-tray", class: "size-3 sm:size-5" %>
      <% end %>
    <% end %>
    <button class="btn btn-secondary btn-sm"
              data-controller="share-trigger"
              data-share-trigger-modal-id-value="<%= modal_id %>"
              data-action="click->share-trigger#open">
      <%= icon "share", class: "size-4"%>
    </button>
  </div>
</div>
<%= render 'shared/share_modal', 
    modal_id: modal_id,
    url: share_url,
    title: resource.title,
    text: resource.title %>
