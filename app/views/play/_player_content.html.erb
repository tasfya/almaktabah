<div data-controller="collapsible"  class="bg-white border-t shadow-lg max-h-[70vh] overflow-y-auto" id="<%= dom_id(resource) %>_player_content">
    <!-- Header Row: Close, Title, Collapse -->
    <div class="flex items-center justify-between px-3 py-2 border-b border-gray-100 sticky top-0 bg-white">
      <%= button_to stop_play_path, method: :delete,
          form: { data: { turbo_stream: true } },
          class: "flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full transition-colors",
          title: t('buttons.close') do %>
        <%= icon "x-mark", class: "w-4 h-4" %>
      <% end %>

      <div class="flex flex-col sm:flex-row sm:items-center items-start gap-3 flex-1 px-2">
        <h2 class="text-sm sm:text-base font-medium text-gray-800 truncate w-full sm:w-auto">
          <%= resource.title %>
        </h2>

        <% if resource.respond_to?(:transcription_segments) && resource.transcription_segments.present? %>
          <div data-controller="captions" data-captions-player-id-value="<%= dom_id(resource) %>" data-captions-segments-value='<%= raw(resource.transcription_segments.to_json) %>' class="flex flex-col sm:flex-row sm:items-center items-start gap-2 flex-1 w-full">
            <!-- cSpell:disable -->
            <span class="text-xs text-gray-500 whitespace-nowrap" title="This transcript was generated by AI and may contain errors">تفريغ آلي — قد يحتوي على أخطاء</span>
            <!-- cSpell:enable -->
            <span data-captions-target="display" id="captions-<%= dom_id(resource) %>" class="text-sm text-gray-700 font-medium whitespace-normal break-words w-full sm:flex-1" style="text-wrap:balance" aria-hidden="true"></span>
          </div>
        <% end %>
      </div>

      <button data-action="click->collapsible#toggle"
              data-collapsible-target="toggleButton"
              class="flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full transition-colors">
        <%= icon "minus", class: "w-4 h-4", data: { collapsible_target: "minimizeIcon" } %>
        <%= icon "plus", class: "w-4 h-4 hidden", data: { collapsible_target: "maximizeIcon" } %>
      </button>
    </div>

    <!-- Collapsible Info -->
    <div data-collapsible-target="content" class="px-3 py-2">
      <div class="flex flex-wrap gap-2 mb-3">
        <% if resource.respond_to?(:category) && resource.category.present? %>
          <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
            <%= resource.category %>
          </span>
        <% end %>
        <% if resource.respond_to?(:media_type) && resource.media_type.present? %>
          <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">
            <%= resource.media_type %>
          </span>
        <% end %>
        <% if resource.respond_to?(:series) && resource.series.present? %>
          <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
            <%= resource.series.title %>
          </span>
        <% end %>
      </div>

      <% if resource.respond_to?(:description) && resource.description.present? %>
        <p class="text-gray-600 text-sm leading-relaxed mb-3">
          <%= truncate(resource.description, length: 200) %>
        </p>
      <% end %>

      <div class="flex gap-2 flex-wrap">
        <% if resource.has_any_audio? %>
          <%= link_to direct_download_url(resource.best_audio),
              download: true, target: "_blank",
              class: "btn btn-primary btn-sm" do %>
            <%= icon "arrow-down-tray", class: "w-4 h-4" %>
            <%= t("buttons.download") %>
          <% end %>
        <% end %>

        <% if resource.respond_to?(:youtube_url) && resource.youtube_url.present? %>
          <%= link_to youtube_embed_url(resource.youtube_url),
              class: "btn btn-secondary btn-sm",
              target: "_blank" do %>
            <%= icon "youtube", library: "lucide", class: "w-4 h-4" %>
            YouTube
          <% end %>
        <% end %>
      </div>

      <%# --- Transcript block: shows segments and allows clicking to seek the audio --- %>
      <%= render partial: 'play/transcript', locals: { resource: resource } %>
    </div>

    <!-- Audio Player -->
    <div class="px-3 py-3 bg-gray-50 sticky bottom-0">
      <% if resource.has_any_audio? %>
        <%= audio_tag resource.best_audio,
            class: "w-full h-10 rounded-lg",
            controls: true,
            preload: "metadata",
            id: dom_id(resource),
            muted: Rails.env.test?,
            data: {
              controller: "player",
              action: "loadeddata->player#play",
              player_title_value: resource.title,
              player_artist_value: resource.respond_to?(:series) && resource.series.present? ? resource.series.title : site_info[:name],
              player_artwork_value: resource.respond_to?(:thumbnail) && resource.thumbnail.attached? ? url_for(resource.thumbnail) : apple_touch_icon_url,
              player_domain_value: site_info[:name]
            } %>

      <% end %>
    </div>
  </div>
