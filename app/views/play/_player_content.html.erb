<div class="bg-white border-t shadow-lg max-h-[70vh] overflow-y-auto p-4 rounded-lg">
  <!-- Header: Title & Close -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex flex-wrap gap-2   min-w-0">
      <h1 class="text-lg font-semibold text-gray-800 truncate">
        <%= resource.respond_to?(:title_for_display) ? resource.title_for_display : resource.title %>
      </h1>
      <% if resource.respond_to?(:category) && resource.category.present? %>
        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
          <%= resource.category %>
        </span>
      <% end %>
      <% if resource.respond_to?(:media_type) && resource.media_type.present? %>
        <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">
          <%= resource.media_type %>
        </span>
      <% end %>
      <% if resource.respond_to?(:series) && resource.series.present? %>
        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
          <%= resource.series.title %>
        </span>
      <% end %>
    </div>
    <%= button_to stop_play_path, method: :delete, 
          form: { data: { turbo_stream: true } },
          class: "flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full transition-colors",
          title: t('buttons.close') do %>
      <%= icon "x-mark", class: "w-4 h-4" %>
    <% end %>
  </div>
  <% if resource.has_any_audio? %>
    <% next_lesson = resource.respond_to?(:next_lesson) ? resource.next_lesson : nil %>
    <% previews_lesson = resource.respond_to?(:previous_lesson) ? resource.previous_lesson : nil %>
    <div class="flex items-center gap-4 mb-4">
      <% if next_lesson.present? %>
        <%= play_button(resource: next_lesson, klass: "btn btn-primary btn-sm whitespace-nowrap", icon_class: "size-4") do %>
          <%= icon "skip-forward", library: "lucide", class: "w-4 h-4 mr-2" %>
          <span>
            <%= t(".next_lesson") %>
          </span>
        <% end %>
      <% end %>
      <% if previews_lesson.present? %>
        <%= play_button(resource: previews_lesson, klass: "btn btn-primary btn-sm whitespace-nowrap", icon_class: "size-4") do %>
          <span>
            <%= t(".previous_lesson") %>
          </span>
          <%= icon "skip-forward", library: "lucide", class: "w-4 h-4 mr-2 rotate-180" %>
        <% end %>
      <% end %>
    </div>
    <!-- Audio Player -->
    <% restore_position = local_assigns[:restore_position] || 0 %>
    <audio 
      id="<%= dom_id(resource) %>" 
      class="w-full" 
      controls 
      preload="metadata"
      muted="<%= Rails.env.test? %>" 
      data-controller="player" 
      data-action="loadedmetadata->player#onMetadataLoaded"
      data-player-title-value="<%= resource.title %>"
      data-player-artist-value="<%= resource.respond_to?(:series) && resource.series.present? ? resource.series.title : site_info[:name] %>"
      data-player-artwork-value="<%= resource.respond_to?(:thumbnail) && resource.thumbnail.attached? ? url_for(resource.thumbnail) : apple_touch_icon_url %>"
      data-player-domain-value="<%= site_info[:name] %>"
      data-player-restore-position-value="<%= restore_position %>"
      data-player-resource-type-value="<%= resource.class.name.underscore %>"
      data-player-resource-id-value="<%= resource.id %>"
      >
      <source src="<%= url_for(resource.best_audio) %>" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
  <% end %>
</div>
