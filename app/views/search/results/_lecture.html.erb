<%
  modal_id = "share_modal_lecture_#{lecture.id}"
  share_url = "#{request.base_url}#{lecture.url}"
%>
<div class="card card-side card-border bg-base-100 relative shadow-sm hover:shadow-lg transition-shadow">
  <div class="card-body">
    <div class="flex items-center gap-2 mb-2">
      <%= icon "microphone", class: "w-5 h-5" %>
      <h2 class="card-title">
        <%= link_to lecture.url, class: "hover:text-primary stretched-link", data: { turbo_frame: "_top" } do %>
          <%= sanitize(lecture.highlighted_title, tags: %w[mark]) %>
        <% end %>
      </h2>
    </div>
    <% if lecture.description.present? %>
      <p class="text-sm line-clamp-3"><%= truncate(strip_tags(lecture.description), length: 150) %></p>
    <% end %>
    <div class="flex items-center gap-2 mb-2">
      <% if lecture.scholar_name.present? %>
        <span class="text-sm text-base-content/70"><%= t('search.results.sheikh') %> <%= lecture.scholar_name %></span>
      <% end %>
      <% if lecture.duration.present? && lecture.duration > 0 %>
        <div class="badge badge-outline badge-sm gap-1">
          <%= icon "clock", class: "w-3 h-3" %>
          <%= format_duration(lecture.duration) %>
        </div>
      <% end %>
    </div>
    <div class="card-actions justify-end mt-auto pt-2">
      <div class="flex items-center gap-2 relative z-10">
        <% if lecture.audio_url.present? %>
          <%= form_with url: play_path(resource_type: "lecture", id: lecture.id),
                        method: :get,
                        local: false,
                        data: {
                          turbo_stream: true,
                          player_id: "lecture_#{lecture.id}_player_content",
                          currently_playing: "false",
                          controller: "play-button",
                          action: "submit->play-button#handleSubmit"
                        } do |form| %>
            <%= form.button type: "submit",
                            class: "btn btn-secondary btn-sm",
                            data: { play_button_target: "button" } do %>
              <span data-play-button-target="playIcon">
                <%= icon "play", class: "w-4 h-4" %>
              </span>
              <span data-play-button-target="pauseIcon" class="hidden">
                <%= icon "pause", class: "w-4 h-4" %>
              </span>
              <span data-play-button-target="loadingIcon" class="hidden">
                <%= icon "arrow-path", class: "w-4 h-4 animate-spin" %>
              </span>
            <% end %>
          <% end %>
          <%= link_to lecture.audio_url, download: true, target: "_blank", class: "btn btn-secondary btn-sm" do %>
            <%= icon "arrow-down-tray", class: "w-4 h-4" %>
          <% end %>
        <% end %>
        <button class="btn btn-secondary btn-sm"
                data-controller="share-trigger"
                data-share-trigger-modal-id-value="<%= modal_id %>"
                data-action="click->share-trigger#open">
          <%= icon "share", class: "w-4 h-4" %>
        </button>
      </div>
    </div>
  </div>
</div>
<%= render 'shared/share_modal',
    modal_id: modal_id,
    url: share_url,
    title: lecture.title,
    text: lecture.title %>
